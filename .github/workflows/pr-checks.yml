name: PR Quality Checks

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pull-requests: write

jobs:
  quality-checks:
    name: Code Quality Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Install root dependencies
        run: npm install
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          npm install --force
          # Ensure Rollup optional dependencies are installed
          npm install @rollup/rollup-linux-x64-gnu --save-optional || true
      
      # ============================================================================
      # STEP 1: LINTING VALIDATION
      # ============================================================================
      - name: üìã Step 1/3 - ESLint Validation
        working-directory: ./frontend
        run: |
          echo "üö® STRICT COMPLIANCE CHECK - ZERO TOLERANCE POLICY"
          echo "‚ö†Ô∏è  NO BYPASSING METHODS ALLOWED - ALL CHECKS MUST PASS"
          echo ""
          echo "üìã Step 1/3: Linting Validation"
          echo "Running ESLint validation (excluding test files)..."
          # Run lint on production code only (exclude test files and __tests__ directories)
          npx eslint 'src/**/*.{ts,tsx}' \
            --ignore-pattern '**/__tests__/**' \
            --ignore-pattern '**/*.test.ts' \
            --ignore-pattern '**/*.test.tsx' \
            --report-unused-disable-directives \
            --max-warnings 3
          if [ $? -ne 0 ]; then
            echo "‚ùå CRITICAL: ESLint errors or warnings found in production code."
            echo "‚ùå ALL production code errors must be fixed before merge."
            echo "üîí ENFORCEMENT: PR blocked - Fix production code errors first"
            echo "üìã REQUIRED: Run 'npm run lint' and fix ALL production code errors/warnings"
            echo "‚ÑπÔ∏è  Note: Test file errors are acceptable and excluded from this check"
            exit 1
          fi
          echo "‚úÖ Production code linting validation passed!"
      
      # ============================================================================
      # STEP 2: TYPE CHECKING
      # ============================================================================
      - name: üìã Step 2/3 - TypeScript Type Checking
        working-directory: ./frontend
        run: |
          echo ""
          echo "üìã Step 2/3: Type Checking"
          echo "Running TypeScript compilation check..."
          npx tsc --noEmit
          if [ $? -ne 0 ]; then
            echo "‚ùå CRITICAL: TypeScript compilation errors found."
            echo "‚ùå ALL TypeScript errors must be fixed before merge."
            echo "üîí ENFORCEMENT: PR blocked - Fix TypeScript errors first"
            echo "üìã REQUIRED: Fix ALL TypeScript compilation errors"
            exit 1
          fi
          echo "‚úÖ Type checking passed!"
      
      # ============================================================================
      # STEP 3: BUILD VALIDATION
      # ============================================================================
      - name: üìã Step 3/3 - Build Validation
        working-directory: ./frontend
        run: |
          echo ""
          echo "üìã Step 3/3: Build Validation"
          echo "Running production build validation..."
          npm run build
          if [ $? -ne 0 ]; then
            echo "‚ùå CRITICAL: Build validation failed."
            echo "‚ùå Production build must succeed - no build errors allowed"
            echo "üîí ENFORCEMENT: PR blocked - Fix build errors first"
            echo "üìã REQUIRED: Run 'npm run build' and fix ALL build errors"
            exit 1
          fi
          echo "‚úÖ Build validation passed!"
      
      # ============================================================================
      # SUCCESS - ALL CHECKS PASSED
      # ============================================================================
      - name: ‚úÖ All Quality Checks Passed
        run: |
          echo ""
          echo "üéâ ALL PR QUALITY CHECKS PASSED!"
          echo "‚úÖ Your code meets ALL quality standards"
          echo "‚úÖ Ready to merge!"
          echo ""
          echo "üîí ENFORCEMENT STATUS: COMPLIANT"
          echo "üìã POLICY: ZERO TOLERANCE - NO BYPASSING ALLOWED"
          echo "‚úÖ RESULT: PR approved - All standards met"
      
      # ============================================================================
      # COMMENT ON PR (Optional - adds a comment when checks pass/fail)
      # ============================================================================
      - name: Comment PR on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **All Quality Checks Passed!**\n\n- ‚úÖ ESLint validation passed (production code only)\n- ‚úÖ TypeScript type checking passed\n- ‚úÖ Build validation passed\n\nYour PR is ready for review! üéâ'
            })
      
      - name: Comment PR on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Quality Checks Failed**\n\nPlease fix the following issues:\n- ESLint errors/warnings in production code\n- TypeScript compilation errors\n- Build validation errors\n\nüîí **ENFORCEMENT**: PR cannot be merged until all checks pass.\n\nüìã **REQUIRED**: Fix all errors and push again.'
            })

