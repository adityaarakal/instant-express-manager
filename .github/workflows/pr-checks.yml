name: PR Quality Checks

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pull-requests: write

jobs:
  quality-checks:
    name: Code Quality Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Install dependencies
        run: |
          # Install root workspace dependencies
          npm install
          # Install frontend workspace dependencies explicitly to ensure optional deps
          cd frontend
          npm install
          # Ensure Rollup optional dependencies are installed (fix for npm workspace bug)
          npm install @rollup/rollup-linux-x64-gnu --save-optional || npm rebuild @rollup/rollup-linux-x64-gnu || true
      
      # ============================================================================
      # STEP 1: LINTING VALIDATION
      # ============================================================================
      - name: ğŸ“‹ Step 1/4 - ESLint Validation
        working-directory: ./frontend
        run: |
          echo "ğŸš¨ STRICT COMPLIANCE CHECK - ZERO TOLERANCE POLICY"
          echo "âš ï¸  NO BYPASSING METHODS ALLOWED - ALL CHECKS MUST PASS"
          echo ""
          echo "ğŸ“‹ Step 1/4: Linting Validation"
          echo "Running ESLint validation (excluding test files)..."
          # Run lint on production code only (exclude test files and __tests__ directories)
          npx eslint 'src/**/*.{ts,tsx}' \
            --ignore-pattern '**/__tests__/**' \
            --ignore-pattern '**/*.test.ts' \
            --ignore-pattern '**/*.test.tsx' \
            --report-unused-disable-directives \
            --max-warnings 3
          if [ $? -ne 0 ]; then
            echo "âŒ CRITICAL: ESLint errors or warnings found in production code."
            echo "âŒ ALL production code errors must be fixed before merge."
            echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix production code errors first"
            echo "ğŸ“‹ REQUIRED: Run 'npm run lint' and fix ALL production code errors/warnings"
            echo "â„¹ï¸  Note: Test file errors are acceptable and excluded from this check"
            exit 1
          fi
          echo "âœ… Production code linting validation passed!"
      
      # ============================================================================
      # STEP 2: TYPE CHECKING
      # ============================================================================
      - name: ğŸ“‹ Step 2/5 - TypeScript Type Checking
        working-directory: ./frontend
        run: |
          echo ""
          echo "ğŸ“‹ Step 2/5: Type Checking"
          echo "Running TypeScript compilation check..."
          npx tsc --noEmit
          if [ $? -ne 0 ]; then
            echo "âŒ CRITICAL: TypeScript compilation errors found."
            echo "âŒ ALL TypeScript errors must be fixed before merge."
            echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix TypeScript errors first"
            echo "ğŸ“‹ REQUIRED: Fix ALL TypeScript compilation errors"
            exit 1
          fi
          echo "âœ… Type checking passed!"
      
      # ============================================================================
      # STEP 3: BUILD VALIDATION
      # ============================================================================
      - name: ğŸ“‹ Step 3/5 - Build Validation
        working-directory: ./frontend
        run: |
          echo ""
          echo "ğŸ“‹ Step 3/5: Build Validation"
          echo "Running production build validation..."
          npm run build
          if [ $? -ne 0 ]; then
            echo "âŒ CRITICAL: Build validation failed."
            echo "âŒ Production build must succeed - no build errors allowed"
            echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix build errors first"
            echo "ğŸ“‹ REQUIRED: Run 'npm run build' and fix ALL build errors"
            exit 1
          fi
          echo "âœ… Build validation passed!"
      
      # ============================================================================
      # STEP 4: MANDATORY MODULE-BASED PLAYWRIGHT TESTS
      # ============================================================================
      - name: ğŸ“‹ Step 4/5 - Mandatory Module-Based Playwright Tests
        run: |
          echo ""
          echo "ğŸ“‹ Step 4/5: Mandatory Module-Based Playwright Tests"
          echo "ğŸš¨ MANDATORY CHECK: Module tests must pass"
          echo "ğŸ“‹ REQUIRED: All module tests must pass before PR can be merged"
          echo ""
          
          # Install Playwright browsers
          cd frontend
          npx playwright install --with-deps chromium
          cd ..
          
          # Run module-based tests
          bash scripts/run-module-tests.sh
          if [ $? -ne 0 ]; then
            echo "âŒ CRITICAL: Playwright tests failed"
            echo "âŒ Module tests must pass before PR can be merged"
            echo "ğŸ”’ ENFORCEMENT: PR blocked - Fix failing tests first"
            echo "ğŸ“‹ REQUIRED: Run 'bash scripts/run-module-tests.sh' and fix failing tests"
            echo "âš ï¸  This check CANNOT BE BYPASSED - All tests must pass"
            exit 1
          fi
          echo "âœ… Module-based Playwright tests passed!"
      
      # ============================================================================
      # STEP 5: MANDATORY VERSION BUMP VALIDATION
      # ============================================================================
      - name: ğŸ“‹ Step 5/5 - Mandatory Version Bump Validation
        run: |
          echo ""
          echo "ğŸ“‹ Step 5/5: Mandatory Version Bump Validation"
          echo "ğŸš¨ MANDATORY CHECK: PR cannot be merged without version bump"
          echo "ğŸ“‹ REQUIRED: Incoming branch version must be ahead of base branch version"
          echo ""
          bash scripts/validate-version-bump.sh
          if [ $? -ne 0 ]; then
            echo "âŒ CRITICAL: Version bump validation failed"
            echo "âŒ ENFORCEMENT: PR blocked - Version bump is MANDATORY"
            echo "ğŸ“‹ REQUIRED: Incoming branch version must be ahead of base branch version"
            echo "âš ï¸  This check CANNOT BE BYPASSED - All PRs must have version bump"
            exit 1
          fi
          echo "âœ… Version bump validation passed!"
      
      # ============================================================================
      # SUCCESS - ALL CHECKS PASSED
      # ============================================================================
      - name: âœ… All Quality Checks Passed
        run: |
          echo ""
          echo "ğŸ‰ ALL PR QUALITY CHECKS PASSED!"
          echo "âœ… Your code meets ALL quality standards"
          echo "âœ… Ready to merge!"
          echo ""
          echo "ğŸ”’ ENFORCEMENT STATUS: COMPLIANT"
          echo "ğŸ“‹ POLICY: ZERO TOLERANCE - NO BYPASSING ALLOWED"
          echo "âœ… RESULT: PR approved - All standards met"
      
      # ============================================================================
      # COMMENT ON PR (Optional - adds a comment when checks pass/fail)
      # ============================================================================
      - name: Comment PR on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **All Quality Checks Passed!**\n\n- âœ… ESLint validation passed (production code only)\n- âœ… TypeScript type checking passed\n- âœ… Build validation passed\n- âœ… **Mandatory module-based Playwright tests passed**\n- âœ… Mandatory version bump validation passed\n\nYour PR is ready for review! ğŸ‰'
            })
      
      - name: Comment PR on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Quality Checks Failed**\n\nPlease fix the following issues:\n- ESLint errors/warnings in production code\n- TypeScript compilation errors\n- Build validation errors\n- **Mandatory module-based Playwright tests** (all tests must pass)\n- **Mandatory version bump validation** (incoming branch version must be ahead of base branch version)\n\nğŸ”’ **ENFORCEMENT**: PR cannot be merged until all checks pass.\n\nğŸ“‹ **REQUIRED**: Fix all errors and push again.'
            })

