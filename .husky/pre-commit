#!/usr/bin/env sh

# ============================================================================
# STRICT COMPLIANCE ENFORCEMENT - ZERO TOLERANCE POLICY
# ============================================================================

echo "üö® STRICT COMPLIANCE CHECK - ZERO TOLERANCE POLICY"
echo "‚ö†Ô∏è  NO BYPASSING METHODS ALLOWED - ALL CHECKS MUST PASS"
echo ""

# ============================================================================
# ABSOLUTE PROHIBITION: --no-verify DETECTION
# ============================================================================
# Note: If we're running, --no-verify wasn't used (Git skips hooks with it)
# But we check parent processes and environment anyway for maximum security

echo "üîç Checking for bypass attempts..."

# Check environment variables
if [ "$HUSKY_SKIP_HOOKS" = "1" ] || [ "$HUSKY" = "0" ] || [ "$SKIP_HOOKS" = "1" ]; then
    echo "‚ùå CRITICAL ERROR: Pre-commit hooks were bypassed!"
    echo "‚ùå This violates the ZERO TOLERANCE POLICY"
    echo "‚ùå All commits MUST pass all validation checks"
    echo ""
    echo "üîí ENFORCEMENT: Commit blocked due to bypass attempt"
    echo "üìã REQUIRED: Fix all issues and commit without bypassing"
    echo ""
    exit 1
fi

# Check parent process for --no-verify flag (works on Unix-like systems)
if command -v ps >/dev/null 2>&1; then
    PARENT_CMD=$(ps -p $PPID -o args= 2>/dev/null || echo "")
    if echo "$PARENT_CMD" | grep -qE "(--no-verify|-n)"; then
        echo "‚ùå CRITICAL ERROR: --no-verify flag detected in commit command!"
        echo "‚ùå ABSOLUTE PROHIBITION: --no-verify is FORBIDDEN at all costs"
        echo "‚ùå NO EXCEPTIONS - NOT EVEN WITH USER PERMISSION"
        echo ""
        echo "üîí ENFORCEMENT: Commit blocked - --no-verify is ABSOLUTELY PROHIBITED"
        echo "üìã REQUIRED: Fix all issues and commit without --no-verify"
        echo "üìã RULE VIOLATION: This violates Zero Bypassing Tolerance"
        echo ""
        exit 1
    fi
fi

# Check for other bypassing methods
if [ -n "$SKIP_HOOKS" ] || [ -n "$SKIP_PRE_COMMIT" ] || [ -n "$BYPASS_CHECKS" ]; then
    echo "‚ùå CRITICAL ERROR: Bypass flags detected!"
    echo "‚ùå Detected bypass flags: SKIP_HOOKS, SKIP_PRE_COMMIT, or BYPASS_CHECKS"
    echo "‚ùå This violates the ZERO TOLERANCE POLICY"
    echo ""
    echo "üîí ENFORCEMENT: Commit blocked due to bypass attempt"
    exit 1
fi

# ============================================================================
# PROTECTION: Prevent commits to main branch
# ============================================================================
current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
if [ "$current_branch" = "main" ]; then
  echo "‚ùå Error: Direct commits to main branch are not allowed!"
  echo "Please create a feature branch and submit a pull request instead."
  echo ""
  echo "Suggested workflow:"
  echo "  1. git checkout -b feature/your-feature-name"
  echo "  2. Make your changes"
  echo "  3. git add . && git commit -m 'your message'"
  echo "  4. git push origin feature/your-feature-name"
  echo "  5. Create a pull request on GitHub"
  echo ""
  echo "üîí ENFORCEMENT: Main branch is protected"
  echo "üìã REQUIRED: Use feature branches and PR workflow"
  exit 1
fi

# ============================================================================
# VERIFY GIT WRAPPER IS ACTIVE
# ============================================================================
# Check if git-wrapper is being used
if command -v ps >/dev/null 2>&1; then
    CMD_LINE=$(ps -p $$ -o args= 2>/dev/null || echo "")
    if ! echo "$CMD_LINE" | grep -q "git-wrapper.sh"; then
        # Check parent processes too
        PARENT_LINE=$(ps -p $PPID -o args= 2>/dev/null || echo "")
        if ! echo "$PARENT_LINE" | grep -q "git-wrapper.sh"; then
            echo "‚ö†Ô∏è  WARNING: Git wrapper not detected - protection may be bypassed"
            echo "‚ö†Ô∏è  Please run: bash scripts/install-git-protection.sh"
            echo "‚ö†Ô∏è  For now, continuing with hook checks..."
            echo ""
        fi
    fi
fi

# ============================================================================
# ENFORCEMENT FILES LOCK VALIDATION
# ============================================================================
# Validate that enforcement files are not modified (only new checks can be added)
# THIS CHECK CANNOT BE REMOVED OR MODIFIED - IT IS PART OF THE LOCK SYSTEM
# Skip lock validation on initial setup (when lock file doesn't exist yet)
if [ -f "scripts/validate-enforcement-lock.sh" ]; then
    if [ -f ".enforcement-lock/checksums.txt" ]; then
        # Lock file exists - validate locks
        echo "üîí Validating enforcement file locks..."
        bash scripts/validate-enforcement-lock.sh
        lock_status=$?
        if [ $lock_status -ne 0 ]; then
            echo ""
            echo "‚ùå CRITICAL: Enforcement file lock validation failed"
            echo "‚ùå ENFORCEMENT: Commit blocked - Files are locked"
            echo "‚ùå MODIFICATION OF ENFORCEMENT FILES IS FORBIDDEN"
            echo "üìã REQUIRED: Only additions of NEW checks allowed, not modifications"
            echo "üìã POLICY: AI agents and users cannot modify existing checks"
            echo ""
            echo "To add a NEW check (requires explicit unlock):"
            echo "  1. Run: bash scripts/unlock-enforcement.sh"
            echo "  2. Provide reason for NEW check"
            echo "  3. Add new check (do not modify existing ones)"
            echo "  4. Commit (locks will re-initialize)"
            echo ""
            echo "See docs/ENFORCEMENT_LOCK.md for details"
            exit 1
        fi
        echo "‚úÖ Enforcement file locks validated"
        echo ""
    else
        # Lock file doesn't exist - initialize locks (first run)
        echo "üîí Initializing enforcement file locks..."
        bash scripts/validate-enforcement-lock.sh
        echo "‚úÖ Enforcement locks initialized"
        echo ""
    fi
fi

# ============================================================================
# STEP 1: MANDATORY VERSION BUMP VALIDATION
# ============================================================================
echo "üìã Step 1/4: Mandatory Version Bump Validation"
echo "üö® MANDATORY CHECK: Commit cannot proceed without version bump"
echo ""
bash scripts/validate-version-bump.sh
if [ $? -ne 0 ]; then
  echo "‚ùå CRITICAL: Version bump validation failed"
  echo "‚ùå ENFORCEMENT: Commit blocked - Version bump is MANDATORY"
  echo "üìã REQUIRED: Branch version must be exactly main + 0.0.1 (PATCH)"
  echo "‚ö†Ô∏è  This check CANNOT BE BYPASSED - All branches must have version bump"
  exit 1
fi
echo "‚úÖ Version bump validation passed!"
echo ""

# ============================================================================
# STEP 2: LINTING VALIDATION
# ============================================================================
echo "üìã Step 2/4: Linting Validation"
echo "Running ESLint validation (excluding test files)..."
cd frontend
# Run lint on production code only (exclude test files and __tests__ directories)
npx eslint 'src/**/*.{ts,tsx}' --ignore-pattern '**/__tests__/**' --ignore-pattern '**/*.test.ts' --ignore-pattern '**/*.test.tsx' --report-unused-disable-directives --max-warnings 3
if [ $? -ne 0 ]; then
  echo "‚ùå CRITICAL: ESLint errors or warnings found in production code."
  echo "‚ùå ALL production code errors must be fixed before commit."
  echo "üîí ENFORCEMENT: Commit blocked - Fix production code errors first"
  echo "üìã REQUIRED: Run 'npm run lint' and fix ALL production code errors/warnings"
  echo "‚ÑπÔ∏è  Note: Test file errors are acceptable and excluded from this check"
  cd ..
  exit 1
fi
cd ..
echo "‚úÖ Production code linting validation passed!"
echo ""

# ============================================================================
# STEP 3: TYPE CHECKING
# ============================================================================
# NOTE: This check can be modified, but only by adding NEW checks
# Modifying existing TypeScript check logic is FORBIDDEN (enforced by lock)
echo "üìã Step 3/4: Type Checking"
echo "Running TypeScript compilation check..."
cd frontend
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "‚ùå CRITICAL: TypeScript compilation errors found."
  echo "‚ùå ALL TypeScript errors must be fixed before commit."
  echo "üîí ENFORCEMENT: Commit blocked - Fix TypeScript errors first"
  echo "üìã REQUIRED: Fix ALL TypeScript compilation errors"
  cd ..
  exit 1
fi
cd ..
echo "‚úÖ Type checking passed!"
echo ""

# ============================================================================
# STEP 4: BUILD VALIDATION
# ============================================================================
# NOTE: This check can be modified, but only by adding NEW checks
# Modifying existing build validation is FORBIDDEN (enforced by lock)
echo "üìã Step 4/4: Build Validation"
echo "Running production build validation..."
cd frontend
npm run build
if [ $? -ne 0 ]; then
  echo "‚ùå CRITICAL: Build validation failed."
  echo "‚ùå Production build must succeed - no build errors allowed"
  echo "üîí ENFORCEMENT: Commit blocked - Fix build errors first"
  echo "üìã REQUIRED: Run 'npm run build' and fix ALL build errors"
  cd ..
  exit 1
fi
cd ..
echo "‚úÖ Build validation passed!"
echo ""

# ============================================================================
# SUCCESS - ALL CHECKS PASSED
# ============================================================================
echo "üéâ ALL PRE-COMMIT VALIDATIONS PASSED!"
echo "‚úÖ Your code meets ALL quality standards"
echo "‚úÖ Ready to commit!"
echo ""
echo "üîí ENFORCEMENT STATUS: COMPLIANT"
echo "üìã POLICY: ZERO TOLERANCE - NO BYPASSING ALLOWED"
echo "‚úÖ RESULT: Commit approved - All standards met"
