#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ============================================================================
# STRICT COMPLIANCE ENFORCEMENT - NO BYPASSING ALLOWED
# ============================================================================

echo "ğŸš¨ STRICT COMPLIANCE CHECK - ZERO TOLERANCE POLICY"
echo "âš ï¸  NO BYPASSING METHODS ALLOWED - ALL CHECKS MUST PASS"
echo ""

# ============================================================================
# ABSOLUTE PROHIBITION: --no-verify DETECTION
# ============================================================================
# Check if --no-verify was used (this should never happen if hook is called)
# But we check anyway to be absolutely certain
echo "ğŸ” Checking for --no-verify usage..."
if [ "$HUSKY_SKIP_HOOKS" = "1" ] || [ "$HUSKY" = "0" ]; then
    echo "âŒ CRITICAL ERROR: Pre-commit hooks were bypassed!"
    echo "âŒ This violates the ZERO TOLERANCE POLICY"
    echo "âŒ All commits MUST pass all validation checks"
    echo ""
    echo "ğŸ”’ ENFORCEMENT: Commit blocked due to bypass attempt"
    echo "ğŸ“‹ REQUIRED: Fix all issues and commit without bypassing"
    echo ""
    exit 1
fi

# Check command line arguments for --no-verify
# This is a safety check - if we're here, the hook is running
# But we check parent processes for any --no-verify flags
if ps -p $PPID -o args= 2>/dev/null | grep -- '--no-verify' > /dev/null 2>&1; then
    echo "âŒ CRITICAL ERROR: --no-verify flag detected in commit command!"
    echo "âŒ ABSOLUTE PROHIBITION: --no-verify is FORBIDDEN at all costs"
    echo "âŒ NO EXCEPTIONS - NOT EVEN WITH USER PERMISSION"
    echo ""
    echo "ğŸ”’ ENFORCEMENT: Commit blocked - --no-verify is ABSOLUTELY PROHIBITED"
    echo "ğŸ“‹ REQUIRED: Fix all issues and commit without --no-verify"
    echo "ğŸ“‹ RULE VIOLATION: This violates Zero Bypassing Tolerance"
    echo ""
    exit 1
fi

# Check for other bypassing methods
if [ -n "$SKIP_HOOKS" ] || [ -n "$SKIP_PRE_COMMIT" ] || [ -n "$BYPASS_CHECKS" ]; then
    echo "âŒ CRITICAL ERROR: Bypass flags detected!"
    echo "âŒ Detected bypass flags: SKIP_HOOKS, SKIP_PRE_COMMIT, or BYPASS_CHECKS"
    echo "âŒ This violates the ZERO TOLERANCE POLICY"
    echo ""
    echo "ğŸ”’ ENFORCEMENT: Commit blocked due to bypass attempt"
    exit 1
fi

# ============================================================================
# PROTECTION: Prevent commits to main branch
# ============================================================================
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" = "main" ]; then
  echo "âŒ Error: Direct commits to main branch are not allowed!"
  echo "Please create a feature branch and submit a pull request instead."
  echo ""
  echo "Suggested workflow:"
  echo "  1. git checkout -b feature/your-feature-name"
  echo "  2. Make your changes"
  echo "  3. git add . && git commit -m 'your message'"
  echo "  4. git push origin feature/your-feature-name"
  echo "  5. Create a pull request on GitHub"
  echo ""
  echo "ğŸ”’ ENFORCEMENT: Main branch is protected"
  echo "ğŸ“‹ REQUIRED: Use feature branches and PR workflow"
  exit 1
fi

# ============================================================================
# STEP 1: LINTING VALIDATION
# ============================================================================
echo "ğŸ“‹ Step 1/3: Linting Validation"
echo "Running ESLint validation (excluding test files)..."
cd frontend
# Run lint on production code only (exclude test files and __tests__ directories)
npx eslint 'src/**/*.{ts,tsx}' --ignore-pattern '**/__tests__/**' --ignore-pattern '**/*.test.ts' --ignore-pattern '**/*.test.tsx' --report-unused-disable-directives --max-warnings 3
if [ $? -ne 0 ]; then
  echo "âŒ CRITICAL: ESLint errors or warnings found in production code."
  echo "âŒ ALL production code errors must be fixed before commit."
  echo "ğŸ”’ ENFORCEMENT: Commit blocked - Fix production code errors first"
  echo "ğŸ“‹ REQUIRED: Run 'npm run lint' and fix ALL production code errors/warnings"
  echo "â„¹ï¸  Note: Test file errors are acceptable and excluded from this check"
  exit 1
fi
cd ..
echo "âœ… Production code linting validation passed!"
echo ""

# ============================================================================
# STEP 2: TYPE CHECKING
# ============================================================================
echo "ğŸ“‹ Step 2/3: Type Checking"
echo "Running TypeScript compilation check..."
cd frontend
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ CRITICAL: TypeScript compilation errors found."
  echo "âŒ ALL TypeScript errors must be fixed before commit."
  echo "ğŸ”’ ENFORCEMENT: Commit blocked - Fix TypeScript errors first"
  echo "ğŸ“‹ REQUIRED: Fix ALL TypeScript compilation errors"
  cd ..
  exit 1
fi
cd ..
echo "âœ… Type checking passed!"
echo ""

# ============================================================================
# STEP 3: BUILD VALIDATION
# ============================================================================
echo "ğŸ“‹ Step 3/3: Build Validation"
echo "Running production build validation..."
cd frontend
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ CRITICAL: Build validation failed."
  echo "âŒ Production build must succeed - no build errors allowed"
  echo "ğŸ”’ ENFORCEMENT: Commit blocked - Fix build errors first"
  echo "ğŸ“‹ REQUIRED: Run 'npm run build' and fix ALL build errors"
  exit 1
fi
cd ..
echo "âœ… Build validation passed!"
echo ""

# ============================================================================
# SUCCESS - ALL CHECKS PASSED
# ============================================================================
echo "ğŸ‰ ALL PRE-COMMIT VALIDATIONS PASSED!"
echo "âœ… Your code meets ALL quality standards"
echo "âœ… Ready to commit!"
echo ""
echo "ğŸ”’ ENFORCEMENT STATUS: COMPLIANT"
echo "ğŸ“‹ POLICY: ZERO TOLERANCE - NO BYPASSING ALLOWED"
echo "âœ… RESULT: Commit approved - All standards met"
